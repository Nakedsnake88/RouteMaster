<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Route Master</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/material-components-web/14.0.0/material-components-web.min.css" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-light: #63a4ff;
      --primary-dark: #004ba0;
      --secondary-color: #f5f5f5;
      --text-color: #333333;
    }

    body {
      font-family: open sans;
      margin: 0;
      padding: 20px;
      background-color: rgba(0,0,0,0.1);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      padding: 10px 0;
		margin-top: 10px;
      margin-bottom: 20px;
      background-color: rgb(239, 240, 238);
      box-shadow: 4px 4px #000000;
      border-radius: 4px;
		border: 2px  solid #000000;
		width: 100%;
    }
	  .container {
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
  padding: 0 15px; /* Spaziatura laterale */
  box-sizing: border-box;
}

     h1 {
  font-family: Raleway;
  color: var(--primary-color);
  font-size: 8vw; /* Adatta la dimensione del testo in base alla larghezza dello schermo */
  text-shadow: 5px 5px rgba(1, 0, 10, 0.44);
  margin: 0;
  font-weight: 900;
}
			p {
			font-family: Open sans;
			font-size: 18px;
				font-weight: 500;
				
		}

    textarea, input[type="file"] {
      width: 100%;
      margin-bottom: 20px;
      padding: 12px;
      border: 2px solid #000000;
      border-radius: 4px;
      background-color: white;
      font-size: 16px;
      transition: border-color 0.3s ease;
		box-shadow: 4px 4px;
		box-sizing: border-box;
		
    }

    textarea:focus {
      border-color: var(--primary-color);
      outline: none;
    
	
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: 2px solid #000000;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: background-color 0.3s ease, transform 0.1s ease;
      box-shadow:  4px 4px #000000;
    }
	  input[type="file"] {
		  width: 100%;
          margin-bottom: 20px;
		  padding: 12px;
		  border: 1px solid #000000;
		  border-radius: 4px;
		  background-color: white;
		  font-size: 16px;
		  box-shadow: 4px 4px #000000;
		  box-sizing: border-box;
			  
	  }
	  .file-input-container{
		  width: 100%;
		  background-color: white;
		  border-radius: 4px;
		  box-shadow: 4px 4px #000000;
		  padding: 12px;
		  margin-bottom: 20px;
		  box-sizing: border-box;
	  }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    #reset {
      background-color: #f44336;
    }

    #export {
      background-color: #4caf50;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 2px 4px rgba(0,0,0,0.1);
		
    }
	  #results {
  overflow-x: auto;
}

    th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: left;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #ffffff;
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    #progress-container {
      margin: 20px 0;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      height: 15px;
      display: none;
    }

    #progress-bar {
      height: 100%;
      width: 0;
      background: var(--primary-color);
      transition: width 0.3s ease;
      text-align: center;
      color: white;
      font-size: 12px;
    }

    .footer {
		font-family: open sans;
      text-align: center;
      padding: 20px;
      margin-top: auto;
      color: #000000;
      font-size: 16px;
		/* Layout responsivo */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }

  .header h1 {
    font-size: 2.5rem; /* Riduce la dimensione del titolo per schermi piccoli */
  }

  textarea, input[type="file"], button {
    padding: 10px; /* Riduce il padding per un layout compatto */
    font-size: 14px; /* Adatta i testi */
  }

  button {
    margin-right: 0; /* Rimuove margini laterali */
    width: 100%; /* Bottoni full-width */
  }

  table th, table td {
    font-size: 14px; /* Adatta la dimensione del testo nelle tabelle */
    padding: 8px; /* Rende più compatto il layout della tabella */
  }

  .footer {
    font-size: 12px; /* Riduce la dimensione del testo nel footer */
  }
}

/* Layout per schermi più grandi */
@media (min-width: 1200px) {
  .header {
    width: 60%;
    margin: 0 auto;
  }

  textarea, input[type="file"] {
    width: 60%; /* Centro il contenuto */
    margin: 0 auto 20px;
  }

  .button-group {
    display: flex;
    justify-content: space-around;
    width: 60%;
    margin: 0 auto;
  }

  #results {
    width: 80%;
    margin: 0 auto;
  }
}
     
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Route Master</h1>
    </div>
    <p><strong>Istruzioni per l'uso:</strong></p>
<p>Inserisci i nomi dei comuni assicurandoti di utilizzare la maiuscola ed eventuali accenti.</p>
<p>Puoi inserire la provincia tra parentesi per evitare errori dovuti a comuni omonimi, come nell'esempio sotto. Nel caso non inserissi la provincia, il calcolo avverrà ugualmente con il campo provincia impostato su "N/A".</p>
<p>Oppure carica un file CSV (con codifica UTF-8) o Excel con almeno le colonne **Comune** e **Provincia**.</p>
    
    <textarea id="municipalities" rows="5" placeholder="Es: Milano (Milano), Roma (Roma), Napoli (Napoli)"></textarea>
    <input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
    
    <div class="button-group">
      <button id="calculate">Calcola</button>
      <button id="reset">Reset</button>
      <button id="export">Esporta in XLSX</button>
    </div>
    
    <div id="progress-container">
      <div id="progress-bar">0%</div>
    </div>
    
    <div id="results"></div>
  </div>

  <footer class="footer">
    Route Master 1.0 | Designed by Alessandro Renna
  </footer>

  <!-- Include Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <!-- Include SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const municipalitiesTextarea = document.getElementById("municipalities");
    const fileInput = document.getElementById("fileInput");
    const resultsDiv = document.getElementById("results");
    const progressBar = document.getElementById("progress-bar");
    const progressContainer = document.getElementById("progress-container");
    const resetButton = document.getElementById("reset");
    const exportButton = document.getElementById("export");

    let resultsData = [];

    // Gestione caricamento file
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      
      if (file.name.endsWith('.csv')) {
        // Gestione CSV
        reader.onload = (e) => {
          const content = e.target.result;
          const lines = content.split('\n').map(line => line.trim()).filter(line => line);
          processFileContent(lines, 'csv');
        };
        reader.readAsText(file);
      } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
        // Gestione Excel
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          processFileContent(rows, 'excel');
        };
        reader.readAsArrayBuffer(file);
      }
    });

    // Elaborazione del contenuto del file
    function processFileContent(data, fileType) {
      let header, rows;
      
      if (fileType === 'csv') {
        header = data[0].split(';');
        rows = data.slice(1);
      } else { // excel
        header = data[0];
        rows = data.slice(1);
      }

      const comuneIndex = header.findIndex(col => 
        col.toLowerCase().includes("comune") || 
        col.toLowerCase().includes("città") ||
        col.toLowerCase().includes("citta"));
      const provinciaIndex = header.findIndex(col => 
        col.toLowerCase().includes("provincia") || 
        col.toLowerCase().includes("prov"));

      if (comuneIndex === -1 || provinciaIndex === -1) {
        alert("Non sono state trovate le colonne 'Comune' e 'Provincia' nel file.");
        return;
      }

      const municipalities = rows.map(row => {
        let columns;
        if (fileType === 'csv') {
          columns = row.split(';');
        } else { // excel
          columns = row;
        }
        
        const municipality = columns[comuneIndex]?.toString().trim();
        const province = columns[provinciaIndex]?.toString().trim();
        
        if (!municipality || !province) {
          console.error("Riga non valida:", row);
          return null;
        }
        return { municipality, province };
      }).filter(item => item !== null);

      window.municipalitiesData = municipalities;
      const names = municipalities.map(item => `${item.municipality} (${item.province})`);
      municipalitiesTextarea.value = names.join(', ');
    }

    // Calcolo lunghezze
    const fetchLengths = async ({ municipality, province }) => {
      const provinceFilter = province ? `
        area[name="${province}"]["boundary"="administrative"]["admin_level"="6"]->.provinceArea;
        area[name="${municipality}"]["boundary"="administrative"]["admin_level"="8"](area.provinceArea)->.searchArea;
      ` : `
        area[name="${municipality}"]["boundary"="administrative"]["admin_level"="8"]->.searchArea;
      `;
      
      const query = `
      [out:json][timeout:50];
      ${provinceFilter}
      way(area.searchArea)["highway"~"^(trunk|primary|secondary|tertiary|unclassified|residential|living_street)$"];
      out geom;
      `;
      const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
      const response = await fetch(url);
      const data = await response.json();

      let totalLength = 0;
      if (data.elements) {
        data.elements.forEach(element => {
          if (element.geometry) {
            const lineCoords = element.geometry.map(coord => [coord.lon, coord.lat]);
            const line = turf.lineString(lineCoords);
            totalLength += turf.length(line);
          }
        });
      }
      return totalLength;
    };

    // Calcolo
    document.getElementById('calculate').addEventListener('click', () => {
      const municipalitiesData = window.municipalitiesData || [];
      const userInput = municipalitiesTextarea.value.split(',').map(m => {
        const [municipality, province] = m.trim().split(/\(|\)/).map(e => e.trim());
        return { municipality, province: province || null };
      });
      const data = municipalitiesData.length > 0 ? municipalitiesData : userInput;

      resultsData = [];
      resultsDiv.innerHTML = "Caricamento in corso...";
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';

      const calculateAll = async () => {
        let resultsHTML = '<table><tr><th>Comune</th><th>Provincia</th><th>Lunghezza Totale (km)</th><th>Tempo di Percorrenza medio (30 km/h)</th></tr>';
        for (let i = 0; i < data.length; i++) {
          const { municipality, province } = data[i];
          const length = await fetchLengths({ municipality, province });
          
          // Calcolo del tempo di percorrenza
          const timeInHours = length / 30; // velocità media 30 km/h
          const hours = Math.floor(timeInHours);
          const minutes = Math.round((timeInHours - hours) * 60);
          const timeString = hours > 0 ? 
            `${hours}h ${minutes}m` : 
            `${minutes}m`;

          resultsHTML += `<tr>
            <td>${municipality}</td>
            <td>${province || "N/A"}</td>
            <td>${length.toFixed(2)}</td>
            <td>${timeString}</td>
          </tr>`;
          
          resultsData.push({ 
            municipality, 
            province, 
            length: length.toFixed(2),
            travelTime: timeString
          });

          const progress = ((i + 1) / data.length) * 100;
          progressBar.style.width = `${progress}%`;
          progressBar.textContent = `${Math.round(progress)}%`;
        }
        resultsHTML += '</table>';
        resultsDiv.innerHTML = resultsHTML;

        progressBar.style.width = '100%';
        progressBar.textContent = 'Completato!';
      };

      calculateAll();
    });

    // Aggiornamento della funzione di esportazione
    exportButton.addEventListener('click', () => {
      if (resultsData.length === 0) {
        alert("Non ci sono risultati da esportare.");
        return;
      }

      const sheetData = [
        ["Comune", "Provincia", "Lunghezza Totale (km)", "Tempo di Percorrenza medio (30 km/h)"],
        ...resultsData.map(row => [
          row.municipality,
          row.province,
          parseFloat(row.length.replace(',', '.')),
          row.travelTime
        ])
      ];

      const worksheet = XLSX.utils.aoa_to_sheet(sheetData);

      // Formattazione delle celle numeriche
      const columnLength = sheetData.length;
      for (let i = 1; i <= columnLength; i++) {
        const cell = worksheet[`C${i}`];
        if (cell && typeof cell.v === 'number') {
          cell.t = 'n';
          cell.z = '0.00';
        }
      }

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Risultati");

      XLSX.writeFile(workbook, "risultati.xlsx");
    });

    // Reset
    resetButton.addEventListener("click", () => {
      municipalitiesTextarea.value = "";
      fileInput.value = "";
      resultsDiv.innerHTML = "";
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";
      progressContainer.style.display = "none";
      resultsData = [];
      window.municipalitiesData = [];
    });
  </script>
</body>
</html>
